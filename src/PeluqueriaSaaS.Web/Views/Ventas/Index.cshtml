@model IEnumerable<PeluqueriaSaaS.Application.DTOs.VentaDto>
@{
    ViewData["Title"] = "Ventas - Lista";
    var fechaFiltro = ViewBag.FechaFiltro as DateTime? ?? DateTime.Today;
    var totalVentas = ViewBag.TotalVentas as decimal? ?? 0;
    var cantidadVentas = ViewBag.CantidadVentas as int? ?? 0;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- HEADER CON ACCIONES -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-receipt text-primary"></i>
                    Ventas del Día
                </h2>
                <div>
                    <a href="@Url.Action("POS")" class="btn btn-success">
                        <i class="fas fa-plus"></i> Nueva Venta
                    </a>
                    <a href="@Url.Action("Reportes")" class="btn btn-outline-info">
                        <i class="fas fa-chart-bar"></i> Reportes
                    </a>
                </div>
            </div>

            <!-- FILTROS Y RESUMEN -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-filter"></i>
                                Filtrar por Fecha
                            </h6>
                            <form method="get" action="@Url.Action("Index")">
                                <div class="input-group">
                                    <input type="date" 
                                           name="fecha" 
                                           value="@fechaFiltro.ToString("yyyy-MM-dd")" 
                                           class="form-control">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Filtrar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-chart-line"></i>
                                Resumen del Día
                            </h6>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="border-end">
                                        <h4 class="text-primary mb-0">@cantidadVentas</h4>
                                        <small class="text-muted">Ventas</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <h4 class="text-success mb-0">$@totalVentas.ToString("F2")</h4>
                                    <small class="text-muted">Total</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TABLA DE VENTAS -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i>
                        Ventas del @fechaFiltro.ToString("dd/MM/yyyy")
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Número</th>
                                        <th>Hora</th>
                                        <th>Cliente</th>
                                        <th>Empleado</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var venta in Model)
                                    {
                                        <tr>
                                            <td>
                                                <strong class="text-primary">@venta.NumeroVenta</strong>
                                            </td>
                                            <td>
                                                @venta.FechaVenta.ToString("HH:mm")
                                            </td>
                                            <td>
                                                <i class="fas fa-user text-muted"></i>
                                                @venta.ClienteNombre
                                            </td>
                                            <td>
                                                <i class="fas fa-user-tie text-muted"></i>
                                                @venta.EmpleadoNombre
                                            </td>
                                            <td>
                                                <strong class="text-success">$@venta.Total.ToString("F2")</strong>
                                                @if (venta.Descuento > 0)
                                                {
                                                    <br><small class="text-warning">
                                                        <i class="fas fa-tag"></i>
                                                        Desc: $@venta.Descuento.ToString("F2")
                                                    </small>
                                                }
                                            </td>
                                            <td>
                                                @if (venta.EstadoVenta == "Completada")
                                                {
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check"></i>
                                                        @venta.EstadoVenta
                                                    </span>
                                                }
                                                else if (venta.EstadoVenta == "Anulada")
                                                {
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-times"></i>
                                                        @venta.EstadoVenta
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning">
                                                        @venta.EstadoVenta
                                                    </span>
                                                }
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a href="@Url.Action("Details", new { id = venta.VentaId })" 
                                                       class="btn btn-outline-info"
                                                       title="Ver detalles">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    
                                                    @if (venta.EstadoVenta == "Completada")
                                                    {
                                                        <button type="button" 
                                                                class="btn btn-outline-warning btn-anular-venta"
                                                                data-venta-id="@venta.VentaId"
                                                                data-venta-numero="@venta.NumeroVenta"
                                                                title="Anular venta">
                                                            <i class="fas fa-ban"></i>
                                                        </button>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No hay ventas para la fecha seleccionada</h5>
                            <p class="text-muted">
                                Seleccione otra fecha o 
                                <a href="@Url.Action("POS")" class="text-decoration-none">
                                    <strong>cree una nueva venta</strong>
                                </a>
                            </p>
                        </div>
                    }
                </div>
            </div>

            <!-- ACCESOS RÁPIDOS -->
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <i class="fas fa-cash-register fa-2x text-primary mb-2"></i>
                            <h6>Nueva Venta</h6>
                            <p class="text-muted small">Procesar nueva venta en POS</p>
                            <a href="@Url.Action("POS")" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Ir al POS
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <i class="fas fa-chart-bar fa-2x text-info mb-2"></i>
                            <h6>Reportes</h6>
                            <p class="text-muted small">Ver reportes y estadísticas</p>
                            <a href="@Url.Action("Reportes")" class="btn btn-info">
                                <i class="fas fa-chart-line"></i> Ver Reportes
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <i class="fas fa-calendar-day fa-2x text-success mb-2"></i>
                            <h6>Ventas de Hoy</h6>
                            <p class="text-muted small">Total del día actual</p>
                            <a href="@Url.Action("Index", new { fecha = DateTime.Today })" class="btn btn-success">
                                <i class="fas fa-today"></i> Ver Hoy
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
$(document).ready(function() {
    // Anular venta
    $('.btn-anular-venta').click(function() {
        const ventaId = $(this).data('venta-id');
        const ventaNumero = $(this).data('venta-numero');
        
        if (confirm(`¿Está seguro que desea anular la venta ${ventaNumero}?`)) {
            $.post('@Url.Action("AnularVenta")', { ventaId: ventaId })
                .done(function(result) {
                    if (result.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + result.message);
                    }
                })
                .fail(function() {
                    alert('Error al anular la venta');
                });
        }
    });

    // Auto-refresh cada 5 minutos para mostrar nuevas ventas
    setTimeout(function() {
        location.reload();
    }, 5 * 60 * 1000);
});
</script>
}